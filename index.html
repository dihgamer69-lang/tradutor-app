<script>
const MAX_CHUNK_SIZE = 4500;

const LANGUAGE_NAMES = {
    en: "Inglês",
    es: "Espanhol",
    fr: "Francês",
    de: "Alemão",
    ru: "Russo",
    it: "Italiano",
    ja: "Japonês",
    ko: "Coreano",
    pl: "Polonês",
    tr: "Turco",
    vi: "Vietnamita"
};

// ===========================
// GLOSSÁRIO: CARREGAMENTO E PROTEÇÃO
// ===========================

let glossary = null;             
let glossaryLowerIndex = null;   
let regexTerms = null;           

async function loadGlossary() {
    if (glossary) return;
    try {
        const res = await fetch("glossario.json");
        glossary = await res.json();

        const terms = Object.keys(glossary);

        glossaryLowerIndex = {};
        for (const t of terms) {
            glossaryLowerIndex[t.toLowerCase()] = t;
        }

        terms.sort((a, b) => b.length - a.length);

        const escaped = terms.map(t => escapeRegex(t));
        regexTerms = new RegExp("\\b(" + escaped.join("|") + ")\\b", "giu");
        console.log("Glossário carregado com", terms.length, "termos.");
    } catch (e) {
        console.error("Erro ao carregar glossário:", e);
        glossary = null;
        glossaryLowerIndex = null;
        regexTerms = null;
    }
}

function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function protegerTermosGlossario(texto) {
    if (!glossary || !regexTerms) return texto;

    return texto.replace(regexTerms, (match) => {
        const canonical = glossaryLowerIndex[match.toLowerCase()] || match;
        return "§GLOSS:" + canonical + "§";
    });
}

function aplicarGlossario(textoTraduzido, idiomaDestino) {
    if (!glossary) return textoTraduzido;

    return textoTraduzido.replace(/§GLOSS:([^§]+)§/g, (full, termoOriginal) => {
        const entry = glossary[termoOriginal];
        if (entry && entry[idiomaDestino]) {
            return entry[idiomaDestino];
        }
        return termoOriginal;
    });
}

function splitText(text, max_len) {
    const chunks = [];
    let current = text.trim();

    while (current.length > max_len) {
        let idx = current.lastIndexOf(".", max_len);
        if (idx === -1) idx = current.lastIndexOf(" ", max_len);
        if (idx === -1) idx = max_len;

        chunks.push(current.substring(0, idx).trim());
        current = current.substring(idx).trim();
    }
    if (current) chunks.push(current);

    return chunks;
}

async function translateChunk(chunk, lang) {
    await loadGlossary();

    const protegido = protegerTermosGlossario(chunk);
    const encoded = encodeURIComponent(protegido);
    const url =
        `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${lang}&dt=t&q=${encoded}`;

    const res = await fetch(url);
    const data = await res.json();

    let translated = data[0].map(s => s[0]).join("");
    translated = aplicarGlossario(translated, lang);
    return translated;
}

function getFriendlyFilename(lang) {
    return `Traducao_${LANGUAGE_NAMES[lang]}`;
}

const sourceTextarea = document.getElementById("sourceText");
const translateButton = document.getElementById("translateButton");
const downloadAllButton = document.getElementById("downloadAllButton");
const messageBox = document.getElementById("messageBox");
const translatedResultsDiv = document.getElementById("translatedResults");

let completedTranslations = {};

translateButton.onclick = translateScript;
downloadAllButton.onclick = downloadAllAsZip;

async function translateScript() {
    const rawText = sourceTextarea.value.trim();
    const langs = [...document.querySelectorAll("input[type=checkbox]:checked")]
        .map(cb => cb.value);

    if (!rawText) {
        messageBox.textContent = "Cole um roteiro antes de traduzir.";
        return;
    }
    if (langs.length === 0) {
        messageBox.textContent = "Selecione pelo menos 1 idioma.";
        return;
    }

    messageBox.textContent = "";
    translatedResultsDiv.innerHTML =
        `<div class='p-4 result-box text-[#a3a3ff]'>STATUS: Dividindo texto e aplicando glossário...</div>`;

    translateButton.textContent = "EXECUTANDO...";
    translateButton.disabled = true;
    downloadAllButton.disabled = true;

    completedTranslations = {};

    const chunks = splitText(rawText, MAX_CHUNK_SIZE);

    for (const lang of langs) {
        translatedResultsDiv.innerHTML += `
            <div id="out-${lang}" class="result-box p-4 rounded">
                <h3 class="text-[#d9b8ff] font-bold">${LANGUAGE_NAMES[lang]} (${lang})</h3>
                <div class="status">0%</div>
                <progress id="pg-${lang}" class="w-full" value="0" max="${chunks.length}"></progress>
                <pre class="content whitespace-pre-wrap mt-2"></pre>
            </div>
        `;

        const out = document.getElementById(`out-${lang}`);
        const bar = document.getElementById(`pg-${lang}`);
        const status = out.querySelector(".status");
        const content = out.querySelector(".content");

        let result = "";

        for (let i = 0; i < chunks.length; i++) {
            const translated = await translateChunk(chunks[i], lang);
            result += translated + "\n\n";

            bar.value = i + 1;
            status.textContent = `${Math.round(((i + 1) / chunks.length) * 100)}%`;
        }

        content.textContent = result;
        completedTranslations[lang] = { content: result };
    }

    messageBox.textContent = "Tradução concluída com glossário aplicado (antes e depois).";
    translateButton.disabled = false;
    translateButton.textContent = "Traduzir Roteiro";
    downloadAllButton.disabled = false;
}

async function downloadAllAsZip() {
    downloadAllButton.textContent = "Gerando ZIP...";
    downloadAllButton.disabled = true;

    const zip = new JSZip();

    for (const lang in completedTranslations) {
        zip.file(`${getFriendlyFilename(lang)}.txt`, completedTranslations[lang].content);
    }

    const blob = await zip.generateAsync({ type: "blob" });
    saveAs(blob, "Traducoes_Roteiro.zip");

    downloadAllButton.textContent = "Baixar Tudo (ZIP)";
    downloadAllButton.disabled = false;
}
</script>
